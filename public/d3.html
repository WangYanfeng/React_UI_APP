<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>D3 Test</title>
    <!-- <script src="./script/d3.js"></script> -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
</head>
<style>
    /* Button & Popup CSS */
    .btn {
        display: inline-block;
        padding: 6px 12px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #fff;
        background-color: #428bca;
        border-color: #357ebd;
    }

    .btn:hover {
        border-radius: 4px;
        background-color: #357ebd;
    }

    .progress-overlay {
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        z-index: 99999;
        background: rgba(34, 33, 33, 0.75);
    }

    .detect-result {
        width: 500px;
        font-size: 16px;
        line-height: 30px;
        position: fixed;
        -webkit-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        left: 50%;
        top: 50%;
        background: #fff;
        padding: 20px 10px 10px 10px;
        z-index: 9999;
        text-align: center;
        border: 3px solid #81CE97;
        border-radius: 20px/50px;
        box-shadow: 0px 0px 15px 0px #81CE97;
        font-family: Arial;
    }

    .detect-result label {
        display: inline-block;
        width: 220px;
    }

    .detect-result .close {
        position: absolute;
        top: 20px;
        right: 30px;
        transition: all 200ms;
        font-size: 30px;
        font-weight: bold;
        text-decoration: none;
        color: #333;
    }

    .detect-result .close:hover {
        color: #81CE97;
    }

    .danger_vul {
        font-size: 16px;
        color: red;
    }

    .danger_vul span {
        font: bold;
        font-size: 20px;
    }

    .progress-pie-chart {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background-color: #E5E5E5;
        position: relative;
        margin: 15% auto 0;
    }

    .progress-pie-chart.gt-50 {
        background-color: #81CE97;
    }

    .gt-50 .ppc-progress .ppc-progress-fill {
        clip: rect(0, 200px, 200px, 100px);
        background: #E5E5E5;
    }

    .ppc-progress {
        content: "";
        position: absolute;
        border-radius: 50%;
        left: calc(50% - 100px);
        top: calc(50% - 100px);
        width: 200px;
        height: 200px;

        clip: rect(0, 200px, 200px, 100px);
    }

    .ppc-progress .ppc-progress-fill {
        content: "";
        position: absolute;
        border-radius: 50%;
        left: calc(50% - 100px);
        top: calc(50% - 100px);
        width: 200px;
        height: 200px;

        clip: rect(0, 100px, 200px, 0);
        background: #81CE97;
        transform: rotate(60deg);
    }

    .gt-50 .ppc-progress {
        clip: rect(0, 100px, 200px, 0);
    }

    .ppc-progress.ppc-progress-fill {
        clip: rect(0, 200px, 200px, 100px);
        background: #E5E5E5;
    }

    .ppc-percents {
        content: "";
        position: absolute;
        border-radius: 50%;
        left: calc(50% - 173.9130434783px/2);
        top: calc(50% - 173.9130434783px/2);
        width: 173.9130434783px;
        height: 173.9130434783px;
        background: #fff;
        text-align: center;
        display: table;
    }

    .ppc-percents span {
        display: block;
        font-size: 2.6em;
        font-weight: bold;
        color: #81CE97;
    }

    .pcc-percents-wrapper {
        display: table-cell;
        vertical-align: middle;
    }
</style>
<style>
    /* control pannel CSS */
    .control-pannel {
        top: 60px;
        width: 180px;
        /* float: left; */
        position: absolute;
        z-index: 99;

        font-family: 'Lato', 'Lucida Grande', 'Lucida Sans Unicode', Tahoma, Sans-Serif;
        line-height: 1.5;
        font-size: 15px;
        font-weight: 400;

        background-color: #e5e5e594;
        border-radius: 5px;
        -webkit-box-shadow: -4px 4px 5px -4px rgba(112, 112, 112, 0.71);
        -moz-box-shadow: -4px 4px 5px -4px rgba(112, 112, 112, 0.71);
        box-shadow: -2px 3px 9px -2px rgba(112, 112, 112, 0.71);
        box-sizing: border-box;
    }

    .category-items {
        padding: 2px 8px;
    }

    .view-btn-items {
        text-align: center;
    }

    .view-btn {
        border-radius: 4px;
        padding: 8px;
        display: inline-block;
        line-height: 1;
        white-space: nowrap;
        cursor: pointer;
        background: none;
        border: 1px solid #e5e5e594;
        color: #606266;
        -webkit-appearance: none;
        text-align: center;
        box-sizing: border-box;
        outline: none;
        margin: 0;
        transition: .1s;
        font-weight: 500;
        /* padding: 12px 20px; */
        font-size: 14px;
        cursor: pointer;
    }

    .view-btn:hover {
        border: 1px solid #357ebd;
        opacity: 0.8;
    }

    .view-btn img {
        width: 25px;
        height: 25px;
    }

    .view-btn.active {
        background-color: #428bca;
        border-color: #357ebd;
    }

    .clm-line {
        height: 1px;
        background: #716d87;
        opacity: .5;
        margin: 0px 5px 5px 5px;
        margin-top: 5px;
    }
</style>
<style>
    /* Topology CSS */
    .node {
        cursor: pointer;
    }

    .device-tip {
        color: white;
        position: absolute;
        visibility: hidden;
        opacity: 0.85;
        padding: 8px;
        min-height: 30px;
        min-width: 200px;
        border-radius: 8px;
        box-shadow: 0 3px 10px black;
        font-size: 10px;
        line-height: 15px;
        font-family: "Microsoft YaHei";
        background-color: #545454;
        pointer-events: none;
        z-index: 99999;
    }

    .device-tip:before {
        content: '';
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 10px 12px 10px 0;
        opacity: 0.9;
        border-color: transparent #545454 transparent transparent;
        position: absolute;
        top: 15px;
        left: 0;
        -webkit-transform: translateX(-100%);
        -moz-transform: translateX(-100%);
        -ms-transform: translateX(-100%);
        -o-transform: translateX(-100%);
        transform: translateX(-100%);
    }

    .device-tip-hr {
        height: 1px;
        background: black;
        opacity: .8;
        margin: 5px 5px 5px 5px;
    }

    .device-tip .tip-header {
        height: 40px;
    }

    .device-tip .tip-header span {
        margin-left: 15px;
        font-size: 16px;
    }

    .device-tip .tip-header img {
        width: 35px;
        height: 35px;
        float: left;
    }

    .tip-items {
        padding: 2px 5px;
    }

    .tip-items label {
        width: 120px;
        display: inline-block;
    }

    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 2px;
    }

    .dev-hostname-text {
        font-size: 12px;
        font-family: "Microsoft YaHei";
        text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
    }

    circle {
        fill-opacity: .5;
        stroke: rgb(31, 119, 180);
        stroke-width: 1px;
    }

    .node--pack text {
        font: 9px sans-serif;
        text-anchor: middle;
    }
</style>

<body translate="no">
    <noscript>You need to enable JavaScript to run this website.</noscript>
    <button class="btn" id="detect_IOT">Detect IOT</button>
    <div class="progress-overlay" style="display: none;">
        <div class="progress-pie-chart">
            <div class="ppc-progress">
                <div class="ppc-progress-fill"></div>
            </div>
            <div class="ppc-percents">
                <div class="pcc-percents-wrapper">
                    <span>0%</span>
                </div>
            </div>
        </div>
        <div class="detect-result" id="detect_result">
            <div style="margin-bottom:10px;">
                <a class="close" href="#">×</a>
            </div>
            <div>
                <label>Total Detected Devices :</label>
                <span>16</span>
            </div>
            <div class="danger_vul">
                <label>CVE : </label>
                <span>6</span>
            </div>
            <div class="danger_vul">
                <label>Weak Passwords : </label>
                <span>5</span>
            </div>
            <div class="danger_vul">
                <label>External Ports : </label>
                <span>3</span>
            </div>
        </div>
    </div>
    <div class="control-pannel" style="display: none;">
        <div class="view-btn-items">
            <button class="view-btn active" title="Tree">
                <img src="image/icon_tree_show.png" />
            </button>
            <button class="view-btn" title="Chart">
                <img src="image/icon_chart_show.png" />
            </button>
            <button class="view-btn" title="Item">
                <img src="image/icon_item_show.png" />
            </button>
        </div>
        <div class="clm-line"></div>
        <div class="category-items">
            <div>
                <input type="checkbox" /> PC (2)
            </div>
            <div>
                <input type="checkbox" /> Android Phone (8)
            </div>
            <div>
                <input type="checkbox" /> iPhone (6)
            </div>
            <div>
                <input type="checkbox" /> iPad (3)
            </div>
            <div>
                <input type="checkbox" /> Apple Watch (2)
            </div>
            <div>
                <input type="checkbox" /> Camera (5)
            </div>
            <div>
                <input type="checkbox" /> Printer Scanner (1)
            </div>
        </div>
    </div>
    <div id="topo_container"></div>
    <div class="device-tip" id="device_tip">
        <div>
            <div class="tip-header" title="Information">
                <img src="image/icon_info.png" id="logo">
                <span id="tip_hostname"></span>
                <br />
                <span id="tip_category" style="font-size:10px;"></span>
            </div>
            <div class="tip-items">
                <label>Device Brand:</label>
                <span id="tip_dev_brand"></span>
            </div>
            <div class="tip-items">
                <label>Device Module:</label>
                <span id="tip_dev_module"></span>
            </div>
            <div class="tip-items">
                <label>Device OS:</label>
                <span id="tip_dev_OS"></span>
            </div>
            <div class="device-tip-hr"></div>
        </div>
        <div>
            <div class="tip-header" title="Network">
                <img src="image/icon_network.png" id="logo">
                <span id="tip_dev_ipv4"></span>
            </div>
            <div class="tip-items">
                <label>MAC Address:</label>
                <span id="tip_dev_mac"></span>
            </div>
            <div class="tip-items">
                <label>Traffic:</label>
                <span id="tip_bytes"></span>
            </div>
            <div class="tip-items">
                <label>Bandwidth:</label>
                <span id="tip_band_width"></span>
            </div>
            <div class="device-tip-hr"></div>
        </div>
        <div>
            <div class="tip-header" title="Security">
                <img src="image/icon_security.png" id="logo">
                <span id="tip_security_score">100</span>
            </div>
            <div class="tip-items">
                <label>Vulnerability:</label>
                <span id="tip_vulnerability"></span>
            </div>
            <div class="tip-items">
                <label>Opened TCP Ports:</label>
                <span id="tip_open_ports_tcp"></span>
            </div>
            <div class="tip-items">
                <label>Opened UDP Ports:</label>
                <span id="tip_open_ports_udp"></span>
            </div>
            <div class="tip-items">
                <label>Weak Password:</label>
                <span id="tip_weak_passwd"></span>
            </div>
        </div>
    </div>
</body>
<script>
    var devicetip = null;
    var topologyMode = "Tree";

    var treeData = null, treemap = null, rootNode = null, treeSVG = null;
    // set tree canvas size
    var margin = { top: 120, right: 60, bottom: 30, left: 120 },
        width = 1600 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;
    // tree node id
    var i = 0;
    // tree animation time
    var duration = 300;

    // Pack circle of chart topo
    var packSize = { width: 200, height: 300 };

    $(function () {
        $("#detect_IOT").click(function () {
            $('.ppc-progress-fill').css('transform', 'rotate(1deg)');
            $('.progress-pie-chart').removeClass('gt-50');
            $('.progress-overlay').show();
            $('.progress-pie-chart').show();
            $('#detect_result').hide();

            let percent = 5;
            let id = setInterval(function () {
                if (percent > 100) {
                    clearInterval(id);
                    //Show detected result
                    $('.progress-pie-chart').hide();
                    $('#detect_result').show();
                    setTreeData();
                } else {
                    let deg = 360 * percent / 100;
                    if (percent > 50) {
                        $('.progress-pie-chart').addClass('gt-50');
                    }
                    $('.ppc-progress-fill').css('transform', 'rotate(' + deg + 'deg)');
                    $('.ppc-percents span').html(percent + '%');
                    percent += 5;
                }
            }, 100);

            function updateProgressBar() {
                if (percent > 100) {
                    clearInterval(id);
                    $('.progress-overlay').hide();
                } else {
                    let deg = 360 * percent / 100;
                    if (percent > 50) {
                        $('.progress-pie-chart').addClass('gt-50');
                    }
                    $('.ppc-progress-fill').css('transform', 'rotate(' + deg + 'deg)');
                    $('.ppc-percents span').html(percent + '%');
                    percent += 5;
                }
            }
        });

        // close detect result, draw tree topology
        $(".detect-result .close").click(function () {
            $('.progress-overlay').hide();
            $(".control-pannel").show();
            if (topologyMode == "Tree") {
                drawTreeTopology();
            } else if (topologyMode == "Chart") {
                drawChartTopology();
            } else if (topologyMode == "Item") {
                alert("show Item");
            } else {
                drawTreeTopology();
            }
        });

        // click control pannel, change  topology mode
        $(".view-btn").click(function () {
            topologyMode = $(this).attr("Title");
            $(this).siblings().removeClass("active");
            $(this).addClass("active");
            if (topologyMode == "Tree") {
                drawTreeTopology();
            } else if (topologyMode == "Chart") {
                drawChartTopology();
            } else if (topologyMode == "Item") {
                alert("show Item");
            } else {
                drawTreeTopology();
            }
        });

        function setTreeData() {
            treeData = {
                "name": "CloudEdge",
                'img': 'image/icon_ce.png',
                "children":
                    [
                        {
                            "name": "LAN1 Switch",
                            'img': 'image/icon_switch.png',
                            "children":
                                [
                                    {
                                        "name": "Child 1.1",
                                        "img": 'image/icon_windows.png',
                                        "dev_ipv4": "192.168.0.100",
                                        "dev_mac": "18:1D:EA:F5:FB:E5",
                                        "dev_brand": "Dell",
                                        "dev_module": "",
                                        "dev_OS": "Windows 10",
                                        "category": "PC",
                                        "hostname": "NJ-LEON-LI",
                                        "bytes": "180.86MB",
                                        "band_width": "150.32kbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [21, 135, 139, 445, 5357],
                                            "udp": [137]
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 1.2",
                                        'img': 'image/icon_windows.png',
                                        "dev_ipv4": "192.168.0.101",
                                        "dev_mac": "30:B4:9E:F3:DF:76",
                                        "dev_brand": "Lenovo",
                                        "dev_module": "",
                                        "dev_OS": "Windows 7",
                                        "category": "PC",
                                        "hostname": "NJ-EDWIN-WANG",
                                        "bytes": "1.53GB",
                                        "band_width": "317kbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [135, 139, 445],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 1.3",
                                        'img': 'image/icon_mac.png',
                                        "dev_ipv4": "192.168.201.102",
                                        "dev_mac": "88:1D:EA:F5:FB:E5",
                                        "dev_brand": "Apple",
                                        "dev_module": "MacBook Pro",
                                        "dev_OS": "Mac OS X",
                                        "category": "MacBook",
                                        "hostname": "NJ-KEN-LI-MAC",
                                        "bytes": "461.33MB",
                                        "band_width": "87.18kbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": [137, 5353]
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 1.4",
                                        'img': 'image/icon_printer.png',
                                        "dev_ipv4": "192.168.0.103",
                                        "dev_mac": "C4:65:16:50:D1:54",
                                        "dev_brand": "HP",
                                        "dev_module": "HP OfficeJet 3830",
                                        "dev_OS": "",
                                        "category": "",
                                        "hostname": "HP OfficeJet 3830 series",
                                        "bytes": "20.28MB",
                                        "band_width": "152.61kbps",
                                        "vulnerability": {
                                            "cve_num": 2,
                                            "cve_list": ["CVE-2017-2741", "CVE-2019-6318"]
                                        },
                                        "open_ports": {
                                            "tcp": [80, 443, 631, 1270, 8080, 9100],
                                            "udp": [137, 161, 5353]
                                        },
                                        "weak_passwd": "",
                                        "security_score": 60
                                    },
                                    {
                                        "name": "Child 1.5",
                                        'img': 'image/icon_camera.png',
                                        "dev_ipv4": "192.168.0.104",
                                        "dev_mac": "28:10:7B:1C:B1:0D",
                                        "dev_brand": "D-LINK",
                                        "dev_module": "D-LINK camera(DCS-930L)",
                                        "dev_OS": "",
                                        "category": "",
                                        "hostname": "DCS-930L",
                                        "bytes": "720.82MB",
                                        "band_width": "152.49kbps",
                                        "vulnerability": {
                                            "cve_num": 1,
                                            "cve_list": ["CVE-2019-10999"]
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "Yes",
                                        "security_score": 80
                                    }
                                ]
                        },
                        {
                            "name": "LAN2",
                            'img': 'image/icon_linux.png',
                            "dev_ipv4": "192.168.1.102",
                            "dev_mac": "00:90:0B:65:0B:09",
                            "dev_brand": "Intel",
                            "dev_module": "",
                            "dev_OS": "CentOS 7.5",
                            "category": "",
                            "hostname": "localhost",
                            "bytes": "8.52GB",
                            "band_width": "28.54Mbps",
                            "vulnerability": {
                                "cve_num": 0,
                                "cve_list": []
                            },
                            "open_ports": {
                                "tcp": [],
                                "udp": [137, 5353]
                            },
                            "weak_passwd": "",
                            "security_score": 100
                        },
                        {
                            "name": "LAN3 AP",
                            'img': 'image/icon_ap.png',
                            "children":
                                [
                                    {
                                        "name": "Child 3.1",
                                        'img': 'image/icon_apple.png',
                                        "dev_ipv4": "192.168.201.101",
                                        "dev_mac": "B0:34:95:16:B5:BB",
                                        "dev_brand": "Apple",
                                        "dev_module": "Wifi only iPad Air",
                                        "dev_OS": "IOS",
                                        "category": "iPad",
                                        "hostname": "Chen-Wang iPad",
                                        "bytes": "920.91kB",
                                        "band_width": "12.57kbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.2",
                                        'img': 'image/icon_apple.png',
                                        "dev_ipv4": "192.168.201.102",
                                        "dev_mac": "C0:CC:F8:3D:DA:ED",
                                        "dev_brand": "Apple",
                                        "dev_module": "iPhone 6s Plus",
                                        "dev_OS": "iPhone/iOS 12.3.1",
                                        "category": "iPhone",
                                        "hostname": "LeoniPhone",
                                        "bytes": "32.30kB",
                                        "band_width": "704.12bps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [62078],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.3",
                                        'img': 'image/icon_android.png',
                                        "dev_ipv4": "192.168.201.103",
                                        "dev_mac": "9C:5C:F9:3C:82:A9",
                                        "dev_brand": "Sony",
                                        "dev_module": "Sony Xperia XZ",
                                        "dev_OS": "Android/8.0.0",
                                        "category": "Android Phone",
                                        "hostname": "android-eeb3c6c7053e39bb",
                                        "bytes": "89.57MB",
                                        "band_width": "10.06kbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.4",
                                        'img': 'image/icon_android.png',
                                        "dev_ipv4": "192.168.201.104",
                                        "dev_mac": "A4:93:3F:80:34:9B",
                                        "dev_brand": "Huawei",
                                        "dev_module": "HUAWEI MediaPad M5",
                                        "dev_OS": "Android/8.1.1",
                                        "category": "Android Tablet",
                                        "hostname": "HUAWEI_MediaPad_M5-ebe24e",
                                        "bytes": "129.04MB",
                                        "band_width": "20.64kbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [80],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.5",
                                        'img': 'image/icon_watch.png',
                                        "dev_ipv4": "192.168.201.105",
                                        "dev_mac": "68:FE:F7:41:BA:7E",
                                        "dev_brand": "Apple",
                                        "dev_module": "Apple Watch",
                                        "dev_OS": "iOS",
                                        "category": "Watch",
                                        "hostname": "GavinsAppleWatch",
                                        "bytes": "159.75kB",
                                        "band_width": "0bps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.6",
                                        'img': 'image/icon_printer.png',
                                        "dev_ipv4": "192.168.201.106",
                                        "dev_mac": "48:5F:99:72:65:05",
                                        "dev_brand": "Brother HL-L2395DW series",
                                        "dev_module": "HL-L2395DW",
                                        "dev_OS": "",
                                        "category": "Printer Scanner",
                                        "hostname": "Brother HL-L2395DW series",
                                        "bytes": "21.19MB",
                                        "band_width": "12.53Mbps",
                                        "vulnerability": {
                                            "cve_num": 1,
                                            "cve_list": ["CVE-2018-11581"]
                                        },
                                        "open_ports": {
                                            "tcp": [80, 443, 515, 631],
                                            "udp": [137, 161, 5353]
                                        },
                                        "weak_passwd": "",
                                        "security_score": 75
                                    },
                                    {
                                        "name": "Child 3.7",
                                        'img': 'image/icon_camera.png',
                                        "dev_ipv4": "192.168.201.107",
                                        "dev_mac": "44:73:D6:0C:FD:56",
                                        "dev_brand": "Logitech",
                                        "dev_module": "LogiCircle",
                                        "dev_OS": "",
                                        "category": "IP Camera",
                                        "hostname": "LogiCircle",
                                        "bytes": "549.12MB",
                                        "band_width": "17.84Mbps",
                                        "vulnerability": {
                                            "cve_num": 1,
                                            "cve_list": ["CVE-2019-13053"]
                                        },
                                        "open_ports": {
                                            "tcp": [80, 443, 515, 631],
                                            "udp": [137, 161, 5353]
                                        },
                                        "weak_passwd": "Yes",
                                        "security_score": 50
                                    },
                                    {
                                        "name": "Child 3.8",
                                        'img': 'image/icon_tv.png',
                                        "dev_ipv4": "192.168.201.108",
                                        "dev_mac": "2C:2B:F9:48:A6:0B",
                                        "dev_brand": "LG",
                                        "dev_module": "LG TV 75UK6200PCB",
                                        "dev_OS": "",
                                        "category": "Smart TV",
                                        "hostname": "LGwebOSTV",
                                        "bytes": "189.32MB",
                                        "band_width": "6.84Mbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.9",
                                        'img': 'image/icon_speaker.png',
                                        "dev_ipv4": "192.168.201.109",
                                        "dev_mac": "3C:5C:C4:ED:02:23",
                                        "dev_brand": "Amazon",
                                        "dev_module": "Echo 2nd",
                                        "dev_OS": "",
                                        "category": "Smart Speaker",
                                        "hostname": "amazon-df3471842",
                                        "bytes": "189.37MB",
                                        "band_width": "6.83Mbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    },
                                    {
                                        "name": "Child 3.10",
                                        'img': 'image/icon_game.png',
                                        "dev_ipv4": "192.168.201.110",
                                        "dev_mac": "F0:6E:0B:6E:33:69",
                                        "dev_brand": "Microsoft",
                                        "dev_module": "Xbox One",
                                        "dev_OS": "",
                                        "category": "Game Console",
                                        "hostname": "Xbox One",
                                        "bytes": "189.32MB",
                                        "band_width": "2.87Mbps",
                                        "vulnerability": {
                                            "cve_num": 0,
                                            "cve_list": []
                                        },
                                        "open_ports": {
                                            "tcp": [],
                                            "udp": []
                                        },
                                        "weak_passwd": "",
                                        "security_score": 100
                                    }
                                ]
                        }
                    ]
            };
        }

        setTreeData();
        drawTreeTopology();
        $(".control-pannel").show();
    });

    function nodeMouseover(d, id, envent) {
        formatDeviceTip(d);
        if (topologyMode === "Tree") {
            devicetip.style("left", d.x + 30 + margin.left + "px")
                .style("top", d.y + margin.top + "px");
        } else if (topologyMode === "Chart") {
            // TODO: when zoom out, the position is not accurate.
            if (d.children) {
                //only show leaf chart info
                return;
            }
            let x = d3.event.pageX;
            let y = d3.event.pageY;
            // console.log(d.belongToPackID);
            let belongPack = d3.select("g.packid_" + d.belongToPackID);
            // console.log(belongPack);
            belongPack.each(function (pack_D) {
                devicetip.style("left", pack_D.x + 35 + d.x + "px")
                    .style("top", pack_D.y + d.y + 35 + "px");
            });
        }
        return devicetip.style("visibility", "visible");
    }

    function nodeMouseout(d, id) {
        return devicetip.style("visibility", "hidden");
    }

    // show device info into message tip
    function formatDeviceTip(d) {
        resetDeviceTip();
        if (d.data.hasOwnProperty("hostname")) {
            $("#tip_hostname").text(d.data.hostname);
        }
        if (d.data.hasOwnProperty("category")) {
            $("#tip_category").text(d.data.category);
        }
        if (d.data.hasOwnProperty("dev_brand")) {
            $("#tip_dev_brand").text(d.data.dev_brand);
        } if (d.data.hasOwnProperty("dev_module")) {
            $("#tip_dev_module").text(d.data.dev_module);
        } if (d.data.hasOwnProperty("dev_OS")) {
            $("#tip_dev_OS").text(d.data.dev_OS);
        } if (d.data.hasOwnProperty("dev_ipv4")) {
            $("#tip_dev_ipv4").text(d.data.dev_ipv4);
        } if (d.data.hasOwnProperty("dev_mac")) {
            $("#tip_dev_mac").text(d.data.dev_mac);
        } if (d.data.hasOwnProperty("bytes")) {
            $("#tip_bytes").text(d.data.bytes);
        } if (d.data.hasOwnProperty("band_width")) {
            $("#tip_band_width").text(d.data.band_width);
        } if (d.data.hasOwnProperty("security_score")) {
            $("#tip_security_score").text(d.data.security_score);
        } if (d.data.hasOwnProperty("vulnerability")) {
            $("#tip_vulnerability").text(d.data.vulnerability.cve_num);
        } if (d.data.hasOwnProperty("open_ports")) {
            $("#tip_open_ports_tcp").text(d.data.open_ports.tcp.length);
        } if (d.data.hasOwnProperty("open_ports")) {
            $("#tip_open_ports_udp").text(d.data.open_ports.udp.length);
        } if (d.data.hasOwnProperty("weak_passwd")) {
            $("#tip_weak_passwd").text(d.data.weak_passwd ? "Yes" : "No");
        }
    }
    function resetDeviceTip() {
        $("#tip_hostname").text("");
        $("#tip_category").text("");
        $("#tip_dev_brand").text("");
        $("#tip_dev_module").text("");
        $("#tip_dev_OS").text("");
        $("#tip_dev_ipv4").text("");
        $("#tip_dev_mac").text("");
        $("#tip_bytes").text("");
        $("#tip_band_width").text(0);
        $("#tip_security_score").text("");
        $("#tip_vulnerability").text("");
        $("#tip_open_ports_tcp").text(0);
        $("#tip_open_ports_udp").text(0);
        $("#tip_weak_passwd").text("No");
    }

    /**  
     * Topology show as Tree mode
     * **/

    function drawTreeTopology() {
        if (!treeData) {
            return;
        }
        if ($("#topo_container svg").length > 0) {
            $("#topo_container svg").remove();
        }
        devicetip = d3.select("#device_tip");

        // Creates a treemap layout with default settings and assigns the size
        treemap = d3.tree().size([width, height]);

        // Construct a rootnode from data
        rootNode = d3.hierarchy(treeData);

        // Prepare svg element
        treeSVG = d3.select("#topo_container").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //update tree node
        rootNode = treemap(rootNode);
        updateTree(rootNode);
    }

    function updateTree(source) {
        const nodes = rootNode.descendants()
        const links = rootNode.descendants().slice(1)
        i = 0;

        // depth normalization
        nodes.forEach(d => d.y = d.depth * 150)

        // ****************** links section ***************************
        // 数据连接，根据目标节点的id绑定数据
        var link = treeSVG.selectAll("path.link").data(links, function (d) { return d.id; });

        //增加新连接
        link.enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d => diagonal(d));
        // 原有连接更新位置
        link.transition().duration(2)
            .attr("d", d => diagonal(d));
        // 折叠的链接，收缩到源节点处
        link.exit().transition().duration(2)
            .attr("d", d => diagonal(d))
            .remove();

        // ****************** Nodes Section: Draw node for each element in data***************************
        // 数据连接，根据id绑定数据
        var node = treeSVG.selectAll("g.node")
            .data(nodes, function (d) {
                return d.id //最初新点开的节点都没有id
                    || (d.id = ++i); //为没有id的节点添加上ID
            });

        // 增加新的子节点
        var nodeEnter = node.enter().append("g")
            .attr("class", function (d) {
                return "node" +
                    (d.children ? " node--internal" : " node--leaf");
            })
            .attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
                //return "translate(" + source.x0 + "," + source.y0 + ")";
            })
            .on('click', clickNode);

        // Draw a image for each node
        nodeEnter.append('image')
            .attr('xlink:href', function (d) {
                return d.data.img
            })
            .attr('x', function (d) { return - 40 })
            .attr('y', function (d) { return - 40 })
            .attr('height', 80)
            .attr('width', 80)
            .on('mouseover', nodeMouseover)
            .on('mouseout', nodeMouseout);
        // add vulnerability number
        nodeEnter.append('ellipse')
            .style('fill', '#ce1414')
            .attr("transform", function (d) {
                return "translate(30, -30)";
            }).on('click', (d, id) => {
                alert("redirect to detail");
            })
            .attr('rx', (d) => 14)
            .attr('ry', (d) => 11)
            .attr('visibility', (d) => {
                if (d.data && d.data.vulnerability && d.data.vulnerability.cve_num > 0)
                    return "visible";
                else
                    return "hidden";
            });
        nodeEnter.append("text")
            .attr("fill", "white")
            .style("background-color", "black")
            .attr("dx", "25")
            .attr("dy", "-25")
            .attr('visibility', (d) => {
                if (d.data && d.data.vulnerability && d.data.vulnerability.cve_num > 0)
                    return "visible";
                else
                    return "hidden";
            })
            .on('click', (d, id) => {
                alert("redirect to detail");
            })
            .text((d) => {
                if (d.data.vulnerability)
                    return d.data.vulnerability.cve_num;
                else
                    return 0;
            });
        // add hostname dom for each node
        nodeEnter.append("text")
            .style("text-anchor", "middle")
            .attr("class", "dev-hostname-text")
            .attr("dx", "0")
            .attr("dy", "55")
            .attr("title", (d) => d.data.hostname)
            .text(function (d) {
                let name = d.data.hostname ? d.data.hostname : d.data.name;
                if (name.length > 12) {
                    name = name.substr(0, 9) + "...";
                }
                return name;
            });

        // 原有节点更新到新位置
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
        // 折叠节点的子节点收缩回来
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + source.x + "," + source.y + ")";
            })
            .remove();

        // 把旧位置存下来，用以过渡
        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function clickNode(n) {
        if (n.children) {
            n._children = n.children;
            n.children = null;
        } else {
            n.children = n._children;
            n._children = null;
        }

        updateTree(n);
    }

    function diagonal(d) {
        return "M" + d.x + "," + d.y
            + "C" + d.x + "," + (d.y + d.parent.y) / 2
            + " " + d.parent.x + "," + (d.y + d.parent.y) / 2
            + " " + d.parent.x + "," + d.parent.y;
    }

    /**  
     * Topology show as Chart mode
     * **/

    function drawChartTopology() {
        if (!treeData) {
            return;
        }
        if ($("#topo_container svg").length > 0) {
            $("#topo_container svg").remove();
        }
        devicetip = d3.select("#device_tip");

        // Creates a treemap layout with default settings and assigns the size
        treemap = d3.tree().size([width, height]);

        let zoom = d3.zoom().scaleExtent([1, 6]).on("zoom", function () {
            treeSVG.attr("transform", d3.event.transform);
        });

        // Construct a rootnode from data
        rootNode = d3.hierarchy(treeData);

        // Prepare svg element
        treeSVG = d3.select("#topo_container").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(zoom);

        //update tree node
        rootNode = treemap(rootNode);
        updateChar(rootNode);
    }

    function updateChar(source) {
        const nodes = rootNode.descendants()
        const links = rootNode.descendants().slice(1)
        i = 0;
        // depth normalization
        nodes.forEach(d => d.y = d.depth * 150)

        // ****************** Nodes Section: Draw node for each element in data***************************
        // 数据连接，根据id绑定数据
        let allNode = treeSVG.selectAll("g.node")
            .data(nodes, function (d) {
                return d.id //最初新点开的节点都没有id
                    || (d.id = ++i); //为没有id的节点添加上ID
            });

        // 增加新的子节点
        let packParent = [];
        let nodeEnter = allNode.enter().append("g")
            .attr("class", function (d) {
                if (d.children) {
                    d.type = "node_tree";
                    return "node node--tree";
                } else {
                    let i = 0;
                    for (i = 0; i < packParent.length; i++) {
                        const element = packParent[i];
                        if (element == d.parent.id) {
                            break;
                        }
                    }
                    if (packParent.length != 0 && i < packParent.length) {
                        d.type = "node_leaf";
                        return "node node--leaf";
                    } else {
                        d.type = "node_pack";
                        d.x = d.parent.x;
                        packParent.push(d.parent.id);
                        return "node node--pack packid_" + d.id;
                    }
                }
            });

        let treeNodes = treeSVG.selectAll("g.node--tree");
        let packNodes = treeSVG.selectAll("g.node--pack");

        treeNodes.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
        // Draw a image for tree node
        treeNodes.append('image')
            .attr('xlink:href', function (d) {
                return d.data.img
            })
            .attr('x', - 40)
            .attr('y', - 40)
            .attr('height', 80)
            .attr('width', 80);

        //Draw pack image for the first leaf node
        packNodes
            .attr("transform", (d) => {
                drawPack(d);
                return "translate(" + (d.x - 100) + "," + (d.y - 100) + ")";
            })

        // ****************** links section ***************************
        // 数据连接，根据目标节点的id绑定数据
        let link = treeSVG.selectAll("path.link").data(links, function (d) { return d.id; });

        //增加新连接
        link.enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d => diagonal(d));
        // 原有连接更新位置
        link.transition()
            .attr("d", d => diagonal(d));
    }

    function diagonal(d) {
        if (d.type != "node_leaf") {
            return "M" + d.x + "," + d.y
                + "C" + d.x + "," + (d.y + d.parent.y) / 2
                + " " + d.parent.x + "," + (d.y + d.parent.y) / 2
                + " " + d.parent.x + "," + d.parent.y;
        }
    }

    function drawPack(pack_d) {
        let packID = pack_d.id;
        // copy the object
        let data = JSON.parse(JSON.stringify(pack_d.parent.data));
        // 仅包含兄弟叶子节点
        data.children = [];
        let len = data.children.length;

        if (pack_d.parent.data.children) {
            pack_d.parent.data.children.forEach(function (d) {
                if (!d.children)
                    data.children.push(d);
            })
        }

        // 离散刻度映射颜色序列
        let colorOrdinal = d3.scaleOrdinal().range(["#fff", "#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f", "#e5c494", "#b3b3b3", "#fbb4ae", "#decbe4"]);
        let pack_layout = d3.pack().size([packSize.width, packSize.height]);
        let packRoot = d3.hierarchy(data)
            .sum(function (d) {
                let traffic = 0;
                if (d.bytes) {
                    traffic = d.bytes.split(".")[0];
                }
                return parseInt(traffic);
            })
            .sort(function (a, b) {
                let traffic_a = 0;
                let traffic_b = 0;
                if (a.bytes) {
                    traffic = a.bytes.split(".")[0];
                }
                if (b.bytes) {
                    traffic = b.bytes.split(".")[0];
                }
                return parseInt(traffic_b) - parseInt(traffic_a);
            });
        let laidOutData = pack_layout(packRoot).descendants();

        packSVG = d3.selectAll("g.node--pack")
            // packSVG = d3.select("#aaaa")
            .filter((d, i) => {
                if (d.id == packID) {
                    return true;
                }
                return false;
            })
            .append("svg")
            .attr("width", packSize.width)
            .attr("height", packSize.height);

        let packNode = packSVG.selectAll(".node--pack")
            .data(laidOutData)
            .enter()
            .append("g")
            .attr("transform", function (d) {
                d.belongToPackID = packID;
                return "translate(" + d.x + "," + d.y + ")";
            })
            .on('mouseover', nodeMouseover)
            .on('mouseout', nodeMouseout);

        packNode.append("circle")
            .attr("r", function (d) {
                return d.r;
            })
            .attr("fill", function (d) {
                return colorOrdinal(d.r);
            });

        packNode.append("text")
            .text(function (d) {
                if (d.r < 13 || d.height != 0)
                    return null;
                let name = d.data.hostname ? d.data.hostname : d.data.name;
                if (name.length > 8) {
                    name = name.substr(0, 5) + "...";
                }
                return name;
            });
    }
</script>

</html>