<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>D3 Test</title>
    <!-- <script src="./script/d3.js"></script> -->
    <script src="https://d3js.org/d3.v4.js"></script>
</head>
<style>
    .node {
        cursor: pointer;
    }

    .tooltip {
        background-color: rgba(57, 52, 63, 0.7);
        color: white;
        position: absolute;
        visibility: hidden;
        opacity: 0.6;
        padding: 10px;
        min-height: 30px;
        min-width: 100px;
        border-radius: 8px;
        box-shadow: 0 3px 10px black;
    }

    .tooltip:before {
        content: '';
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 10px 12px 10px 0;
        opacity: 0.6;
        border-color: transparent rgba(57, 52, 63, 0.7) transparent transparent;
        position: absolute;
        top: 15px;
        left: 0;
        -webkit-transform: translateX(-100%);
        -moz-transform: translateX(-100%);
        -ms-transform: translateX(-100%);
        -o-transform: translateX(-100%);
        transform: translateX(-100%);
    }

    .node--internal text {
        text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
    }

    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 2px;
    }
</style>

<body translate="no">
    <noscript>You need to enable JavaScript to run this website.</noscript>
    <div id="d3_container" style="height: 100%;"></div>
</body>

<script>
    var treeData = {
        "name": "CloudEdge",
        'img': 'image/gateway.png',
        "children":
            [
                {
                    "name": "Parent 1",
                    'img': 'image/switch.png',
                    "children":
                        [
                            {
                                "name": "Child 1",
                                'img': 'image/wifi.png',
                                "children":
                                    [
                                        {
                                            "name": "Child 1.1",
                                            'img': 'image/ipad.png',
                                            "description": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed.", "url": "http:example.com"
                                        },
                                        {
                                            "name": "Child 1.2",
                                            'img': 'image/iPhone.png',
                                            "description": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed.", "url": "http:example.com"
                                        },
                                        {
                                            "name": "Child 1.3",
                                            'img': 'image/iPhone.png',
                                            "description": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed.", "url": "http:example.com"
                                        }
                                    ]
                            },
                            {
                                "name": "Child 2",
                                'img': 'image/wifi.png',
                                "children":
                                    [
                                        {
                                            "name": "Child 2.1",
                                            'img': 'image/macBook.png',
                                            "description": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed.", "url": "http:example.com"
                                        },
                                        {
                                            "name": "Child 2.2",
                                            'img': 'image/winBook.png',
                                            "description": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed.", "url": "http:example.com"
                                        }
                                    ]
                            }
                        ]
                },
                {
                    "name": "Parent 3",
                    'img': 'image/switch.png',
                    "children":
                        [
                            {
                                "name": "Child 3.1",
                                'img': 'image/pc.png',
                            },
                            {
                                "name": "Child 3.2",
                                'img': 'image/pc.png',
                            },
                            {
                                "name": "Child 3.3",
                                'img': 'image/printer.png',
                            }
                        ]
                }
            ]

    };

    var margin = { top: 40, right: 60, bottom: 30, left: 150 },
        width = 1600 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;
    var i = 0, duration = 500;

    var tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .text("");

    // Creates a treemap layout with default settings and assigns the size
    var treemap = d3.tree().size([width, height]);

    // Construct a rootnode from data
    var rootNode = d3.hierarchy(treeData);

    // Prepare svg element
    var treeSVG = d3.select("#d3_container").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //update tree node
    rootNode = treemap(rootNode);
    updateTree(rootNode);

    function updateTree(source) {
        const nodes = rootNode.descendants()
        const links = rootNode.descendants().slice(1)

        // depth normalization
        nodes.forEach(d => d.y = d.depth * 150)

        // ****************** links section ***************************
        // 数据连接，根据目标节点的id绑定数据
        var link = treeSVG.selectAll("path.link").data(links, function (d) { return d.id; });

        //增加新连接
        link.enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d => diagonal(d));
        // 原有连接更新位置
        link.transition().duration(2)
            .attr("d", d => diagonal(d));
        // 折叠的链接，收缩到源节点处
        link.exit().transition().duration(2)
            .attr("d", d => diagonal(d))
            .remove();

        // ****************** Nodes Section: Draw node for each element in data***************************
        // 数据连接，根据id绑定数据
        var node = treeSVG.selectAll("g.node")
            .data(nodes, function (d) {
                return d.id //最初新点开的节点都没有id
                    || (d.id = ++i); //为没有id的节点添加上ID
            });

        // 增加新的子节点
        var nodeEnter = node.enter().append("g")
            .attr("class", function (d) {
                return "node" +
                    (d.children ? " node--internal" : " node--leaf");
            })
            .attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
                //return "translate(" + source.x0 + "," + source.y0 + ")";
            })
            .on('click', clickNode)
            .on('mouseover', nodeMouseover)
            .on('mouseout', nodeMouseout);
        // Draw a image for each node
        nodeEnter.append('image')
            .attr('xlink:href', function (d) {
                return d.data.img
            })
            .attr('x', function (d) { return - 50 })
            .attr('y', function (d) { return - 70 })
            .attr('height', 140)
            .attr('width', 100);

        // 原有节点更新到新位置
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
        // 折叠节点的子节点收缩回来
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + source.x + "," + source.y + ")";
            })
            .remove();

        // 把旧位置存下来，用以过渡
        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function clickNode(n) {
        if (n.children) {
            n._children = n.children;
            n.children = null;
        } else {
            n.children = n._children;
            n._children = null;
        }

        updateTree(n);
    }

    function nodeMouseover(d, id) {
        console.log(d);
        console.log(id);

        tooltip.text(d.data.name)
            .style("left", d.x + 30 + margin.left + "px")
            .style("top", d.y + margin.top + "px");
        return tooltip.style("visibility", "visible");
    }

    function nodeMouseout(d, id) {
        tooltip.text("");
        return tooltip.style("visibility", "hidden");
    }

    function diagonal(d) {
        return "M" + d.x + "," + d.y
            + "C" + d.x + "," + (d.y + d.parent.y) / 2
            + " " + d.parent.x + "," + (d.y + d.parent.y) / 2
            + " " + d.parent.x + "," + d.parent.y;
    }
</script>

</html>